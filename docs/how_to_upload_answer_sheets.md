# 回答の登録方法

このドキュメントでは、ユーザーの回答データをCSVファイルからデータベースに登録する手順について説明します。

## 1. CSVファイルの準備

### ファイルフォーマット

CSVファイルは以下のヘッダー形式で作成してください：

```csv
date,title,q1,q2,q3,q4,q5,genre,age,gender,name
```

### 各カラムの説明

| カラム名 | 説明 | 例 |
|---------|------|-----|
| `date` | 投稿日時 | `2025-01-11 7:21:15` |
| `title` | 投稿のタイトル | `橋本病の治療で20年以上の薬物治療` |
| `q1` | 質問1の回答（病気の概要） | 疾患について詳しく記述 |
| `q2` | 質問2の回答（症状に気付いたタイミング） | 症状の発見経緯 |
| `q3` | 質問3の回答（不満・不安） | 抱えている不安や不満 |
| `q4` | 質問4の回答（治療内容） | 治療方法や使用薬剤 |
| `q5` | 質問5の回答（現在の経過） | 現在の状況やアドバイス |
| `genre` | カテゴリ名 | `ホルモン・代謝`, `骨・関節・筋肉` など |
| `age` | 年代 | `60代`, `40代` など |
| `gender` | 性別 | `男`, `女` |
| `name` | ユーザー名 | `サクラネTomo589` |

### 利用可能なカテゴリ

利用可能なカテゴリは実際のデータベースから動的に取得されます。現在のカテゴリ一覧を確認するには：

```bash
turbo upload:status
```

標準的なカテゴリ：

- 頭・脳・神経
- 耳鼻・口・目
- 手足・肩・腰
- 心臓・肺・気道
- 血管・血液
- 胃・食道・腸
- 肝臓・膵臓・胆嚢
- 腎臓・尿路・尻
- 皮膚・肌・髪
- 骨・関節・筋肉
- ストレス・睡眠
- ホルモン・代謝
- 心・精神
- 感染症
- がん
- 生活習慣病
- 免疫疾患
- 遺伝子疾患
- 男性に多い疾患
- 女性に多い疾患
- 子供に多い疾患
- その他

### サンプルデータ

```csv
date,title,q1,q2,q3,q4,q5,genre,age,gender,name
2025-01-11 7:21:15,橋本病の治療で20年以上の薬物治療,甲状腺の橋本病で約20年ほど薬を飲み続けています...,そもそもうつ病があったので検査の数値にハッキリあらわれる病気だとわかったときには...,当時うつ病で通院していました...,橋本病は免疫機能が自分の甲状腺を攻撃してしまうことで...,ここまでも書いてきましたが私に起こっているこの症状が橋本病のものであるかどうか...,ホルモン・代謝,60代,女,サクラネTomo589
```

## 2. CSVファイルの転送

サーバーにCSVファイルを転送します：

```bash
scp -i ~/.ssh/id_rsa [CSVファイル名].csv ubuntu@43.207.235.163:~/patient-voice/answer_seed.csv
```

**注意事項：**
- ファイル名は `answer_seed.csv` として転送してください
- SSH秘密鍵のパスが正しいことを確認してください

## 3. データベースへの登録

### サーバーへの接続

```bash
ssh -i ~/.ssh/id_rsa ubuntu@43.207.235.163
```

### プロジェクトディレクトリへの移動

```bash
cd patient-voice
```

### DB の接続設定

```bash
export DATABASE_URL="postgresql://postgres:lHsEibSuxmeN0Equfqy4SNhInqTAWXrZ@patient-voice-prod-rds-instance-db.c5m6gy60qgre.ap-northeast-1.rds.amazonaws.com:5432/mydatabase"
```

### CSVアップロードの実行

```bash
turbo upload
```

### 進捗・データベース情報確認

アップロード中や完了後に進捗とデータベース情報を確認できます：

```bash
turbo upload:status
```

**表示される情報:**
- データベース情報（カテゴリ数、質問数、投稿数、ユーザー数）
- 利用可能なカテゴリ一覧
- アップロード進捗状況
- エラー詳細（該当する場合）

### 進捗のリセット

エラーが発生した場合や最初からやり直したい場合：

```bash
turbo upload:status reset
```

## 4. 処理の詳細

### アップロード処理の流れ

1. **データベース接続確認**: データベースに接続し、マスターデータを確認します
2. **バリデーション用データ取得**: カテゴリ一覧と質問数をデータベースから取得します
3. **CSVファイル読み込み**: `answer_seed.csv`ファイルを読み込みます
4. **全行バリデーション**: 登録前にすべての行のデータ形式をチェックします
5. **進捗管理**: `upload-progress.json`ファイルで進捗を記録します
6. **データ登録**: Prismaを使用してデータベースに順次登録します
7. **エラー処理**: 失敗した行は記録され、成功した行から再開可能です

### バリデーション項目

以下の項目がチェックされます：

- **日付**: 正しい日付形式かどうか
- **タイトル**: 空でないかどうか
- **質問回答（q1-qN）**: データベースの質問数に応じて動的にチェック
- **カテゴリ**: データベースに登録されている有効なカテゴリ名かどうか
- **年齢**: 数値として解析可能かどうか
- **性別**: 「男」または「女」かどうか
- **ユーザー名**: 空でないかどうか

### データ変換処理

アップロード時に以下の変換が行われます：

1. **年代から生年月日への変換**: `60代` → 現在年から60歳を引いた年月日がユーザーの生年月日として登録される
2. **性別の変換**: `男` → `MALE`, `女` → `FEMALE`
3. **カテゴリ名のマッピング**: CSVのgenreカラムからカテゴリIDへの変換
4. **ユーザー作成**: 各行に対して一意のユーザーが作成されます（foreignId: `csv-upload:{行番号}:{タイムスタンプ}`）

### 進捗管理とエラーハンドリング

- **進捗保存**: 10行ごとに進捗が保存されます
- **中断・再開**: 処理が中断されても、最後に成功した行から再開できます
- **エラー記録**: 失敗した行の詳細情報が記録されます
- **バリデーションエラー**: 事前バリデーションでエラーがある場合、登録処理は開始されません

## 5. 確認方法

データが正常に登録されたかは、Webアプリケーションで投稿一覧を確認するか、データベースに直接クエリを実行して確認できます。

## 6. トラブルシューティング

### よくある問題と対処法

1. **バリデーションエラー**
   - 問題: CSVのデータ形式が正しくない
   - 対処: エラーメッセージを確認し、該当行のデータを修正

2. **カテゴリ名エラー**
   - 問題: CSVのgenreカラムが利用可能なカテゴリ名と一致しない
   - 対処: 利用可能なカテゴリ名リストを確認し、正確な名前を使用

3. **文字エンコーディングエラー**
   - 問題: CSVファイルがUTF-8でエンコードされていない
   - 対処: CSVファイルをUTF-8で保存し直す

4. **途中で処理が停止**
   - 問題: ネットワークエラーやサーバー停止
   - 対処: `turbo upload`を再実行すると、停止した箇所から再開されます

5. **データベース接続エラー**
   - 問題: DATABASE_URL環境変数が設定されていない
   - 対処: 環境変数を確認し、正しいデータベースURLを設定

### コマンド一覧

```bash
# アップロード実行
turbo upload                     # CSVアップロード実行

# 進捗・データベース情報確認
turbo upload:status              # 進捗状況とDB情報を表示

# 進捗リセット（最初からやり直し）
turbo upload:status reset        # 進捗をリセット

# 進捗ファイル手動削除
rm upload-progress.json          # 進捗ファイルを手動削除
```

### ログの確認

エラーが発生した場合は、以下のような詳細なメッセージが表示されます：

**バリデーションエラーの例:**
```
❌ バリデーションエラーが発生しました:
   行123: genre - 無効なカテゴリです。利用可能なカテゴリ: 頭・脳・神経, 耳鼻・口・目, ... (値: "無効なカテゴリ名")
   行456: age - 年齢の形式が正しくありません (値: "不正な年齢")
```

**データベース接続エラーの例:**
```
❌ データベースからのデータ取得に失敗しました: connect ECONNREFUSED 127.0.0.1:5432
```

**進捗状況表示の例:**
```
🗄️ データベース情報:
   カテゴリ数: 22
   質問数: 5
   投稿数: 1234
   ユーザー数: 567
   利用可能なカテゴリ: 頭・脳・神経, 耳鼻・口・目, 手足・肩・腰, ...

📊 アップロード進捗状況
==================================================
開始時刻: 2025/1/15 14:30:15
状態: 実行中
処理済み: 150/1000 (15%)
成功: 148
失敗: 2
```

